#!/usr/bin/env bash
#
# Script to check for typos in the Jenkins.io repository using the typos tool.
#
# This script supports the following options:
#   --help, -h      Display usage information and examples
#   --verbose, -v   Enable detailed output during typo checking
#
# Without any options, the script runs silently and only displays found typos.
#
# Usage examples:
#   ./scripts/check-typos              # Basic usage (silent mode)
#   ./scripts/check-typos --help       # Show help message
#   ./scripts/check-typos --verbose    # Show detailed progress

set -o errexit
set -o nounset
set -o pipefail

TYPOS_VERSION=v1.40.0
VERBOSE=0  # Set to 1 when --verbose flag is used

# Display help message with usage information and examples
show_help() {
    cat << EOF
Usage: ./scripts/check-typos [OPTIONS]

Check for typos in the repository.

OPTIONS:
    -h, --help      Show this help message
    -v, --verbose   Show detailed output

EXAMPLES:
    ./scripts/check-typos
    ./scripts/check-typos --verbose

EOF
}

# Parse command-line arguments
# Supports --help/-h to display usage and --verbose/-v for detailed output
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            # Display help message and exit
            show_help
            exit 0
            ;;
        -v|--verbose)
            # Enable verbose mode for detailed progress messages
            VERBOSE=1
            shift
            ;;
        *)
            # Handle unknown options gracefully
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Download the typos binary from GitHub releases
# In verbose mode, shows a progress message during download
if [[ $VERBOSE -eq 1 ]]; then
    echo "Downloading typos ${TYPOS_VERSION}..."
fi

if [[ $OSTYPE == darwin* ]] ; then
    curl --disable --silent --show-error --location "https://github.com/crate-ci/typos/releases/download/${TYPOS_VERSION}/typos-${TYPOS_VERSION}-x86_64-apple-darwin.tar.gz" | tar xzf - ./typos
else
    curl --disable --silent --show-error --location "https://github.com/crate-ci/typos/releases/download/${TYPOS_VERSION}/typos-${TYPOS_VERSION}-x86_64-unknown-linux-musl.tar.gz" | tar xzf - ./typos
fi

# Run typos with the appropriate output format
# In CI environments, generates a SARIF report for integration with GitHub's code scanning
# In local development:
#   - Verbose mode: Shows progress and uses detailed output format
#   - Normal mode: Runs silently, only showing typos if found
if [[ -v CI ]] ; then
    if [[ $VERBOSE -eq 1 ]]; then
        echo "Running in CI mode..."
    fi
    ./typos --format sarif > typos.sarif || true
else
    if [[ $VERBOSE -eq 1 ]]; then
        echo "Checking for typos..."
        ./typos --format long  # Long format shows file paths and context
    else
        ./typos  # Brief format for quick checks
    fi
fi
