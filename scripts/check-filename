#!/usr/bin/env bash
set -euo pipefail

dir="${1:-../content/blog/}"

if [[ -z "$dir" ]]; then
  echo "Usage: $0 <directory>"
  exit 2
fi

if [[ ! -d "$dir" ]]; then
  echo "ERROR: $dir is not a directory"
  exit 3
fi

# Valid basename pattern: 4 digits-2 digits-2 digits, optionally followed by '-' or '.' and the rest
# Examples: 2026-01-31, 2026-01-31-title.md, 2026-01-31.md
regex=".*/[0-9]{4}-[0-9]{2}-[0-9]{2}([-.].*)?"

# Find all files recursively, exclude any directory named 'authors' and files named 'index.html.haml',
# and print relative paths that DO NOT match the pattern
mapfile -t non_matching < <(find "$dir" \( -type d -name authors -prune \) -o \( -type f -name 'index.html.haml' -prune -o -type f -regextype posix-extended ! -regex "$regex" -printf '%P\n' \))

if (( ${#non_matching[@]} )); then
  echo "ERROR: non-matching files:"
  printf '%s\n' "${non_matching[@]}"
  exit 1
else
  echo "OK: all file names match"
  exit 0
fi
