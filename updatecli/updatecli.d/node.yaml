---
name: Bump NodeJS version (docker image) to follow packer-image infra version

scms:
  default:
    kind: github
    spec:
      user: "{{ .github.user }}"
      email: "{{ .github.email }}"
      owner: "{{ .github.owner }}"
      repository: "{{ .github.repository }}"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ .github.username }}"
      branch: "{{ .github.branch }}"

sources:
  getDeployedPackerImageVersion:
    kind: file
    name: Retrieve the current version of the Packer images used in production
    spec:
      file: https://raw.githubusercontent.com/jenkins-infra/kubernetes-management/refs/heads/main/config/jenkins_infra.ci.jenkins.io.yaml
      matchpattern: 'galleryImageVersion:\s"(.*)"'
    transformers:
      - findsubmatch:
          pattern: 'galleryImageVersion:\s"(.*)"'
          captureindex: 1
  getNodeVersionFromPackerImages:
    kind: file
    name: Get the NodeJS version set in packer-images
    dependson:
      - getDeployedPackerImageVersion
    spec:
      file: https://raw.githubusercontent.com/jenkins-infra/packer-images/{{ source "getDeployedPackerImageVersion" }}/provisioning/tools-versions.yml
      matchpattern: 'node.*_version:\s(.*)'
    transformers:
      - findsubmatch:
          pattern: 'node.*_version:\s(.*)'
          captureindex: 1

conditions:
  checkDockerImagePublished:
    name: Test node:{{ source "getNodeVersionFromPackerImages" }} docker image tag
    sourceid: getNodeVersionFromPackerImages
    kind: dockerimage
    spec:
      image: "node"
      ## Tag from source

targets:
  setNodeImageVersion:
    name: "Bump Node Image version in scripts/node"
    kind: file
    sourceid: getNodeVersionFromPackerImages
    spec:
      file: scripts/node
      matchpattern: 'CONTAINER_NAME=node:.*'
      replacepattern: 'CONTAINER_NAME=node:{{ source "getNodeVersionFromPackerImages" }}'
    scmid: default
  setNodeVersionFile:
    name: "Bump Node version in .node-version"
    kind: file
    sourceid: getNodeVersionFromPackerImages
    spec:
      file: .node-version
    scmid: default
  setNodeImageVersionInDockerfile:
    name: "Bump Node Image version in Dockerfile"
    kind: file
    sourceid: getNodeVersionFromPackerImages
    spec:
      file: Dockerfile
      matchpattern: 'FROM node:.*'
      replacepattern: 'FROM node:{{ source "getNodeVersionFromPackerImages" }} as node'
    scmid: default

actions:
  default:
    kind: github/pullrequest
    scmid: default
    title: Bump Node version to {{ source "getNodeVersionFromPackerImages" }} to match packer-images in production
    spec:
      labels:
        - dependencies
        - nodejs
