:imagesdir: ../resources/

include::abbr.asc[]

[id=pipeline-as-code]
== Pipeline as Code

[id=pipeline-as-code-intro]
=== Introduction

_Pipeline as Code_ describes a set of features that allow Jenkins users to define pipelined job processes with code, stored and versioned in a source repository.
These features allow Jenkins to discover, manage, and run jobs for multiple source repositories and branches -- eliminating the need for manual job creation and management.

****
To use _Pipeline as Code_, projects must contain a file named `Jenkinsfile` in the repository root, which contains a link:../cje-user-guide/workflow.html[Pipeline Script].

Additionally, one of the enabling jobs needs to be configured in Jenkins:

    * _Multibranch Pipeline_: build multiple branches of a _single_ repository automatically
    * _Organization Folders_: scan a *GitHub Organization* or *Bitbucket Team* to discover an organization's repositories, automatically creating managed _Multibranch Pipeline_ jobs for them

****

Fundamentally, an organization's repositories can be viewed as a hierarchy, where each repository may have child elements of branches and pull requests.

.Example Repository Structure
....
+--- GitHub Organization
    +--- Project 1
        +--- master
        +--- feature-branch-a
        +--- feature-branch-b
    +--- Project 2
        +--- master
        +--- pull-request-1
        +--- etc...
....

Prior to _Multibranch Pipeline_ jobs and _Organization Folders_, link:https://wiki.jenkins-ci.org/display/JENKINS/CloudBees+Folders+Plugin[CloudBees Folders] 
could be used to create this hierarchy in Jenkins by organizing repositories into folders containing jobs for each individual branch.

_Multibranch Pipeline_ and _Organization Folders_ eliminate the manual process by detecting branches and repositories, respectively, and creating
appropriate folders with jobs in Jenkins automatically.


==== The Jenkinsfile

Presence of the `Jenkinsfile` in the root of a repository makes it eligible for Jenkins to automatically manage and execute jobs based on repository branches.

The `Jenkinsfile` should contain a link:../cje-user-guide/workflow.html[Pipeline Script], specifying the steps to execute the job.
The script has all the power of Pipeline available, from something as simple as invoking a Maven builder,
to a series of interdependent steps, which have coordinated parallel execution with deployment and validation phases.

A simple way to get started with Pipeline is to use the _Snippet Generator_ available in the configuration screen for a Jenkins _Pipeline_ job.
Using the _Snippet Generator_, you can create a Pipeline script as you might through the dropdowns in other Jenkins jobs.


==== Folder Computation

_Multibranch Pipeline_ projects and _Organization Folders_ extend the existing folder functionality by introducing 'computed' folders.
Computed folders automatically run a process to manage the folder contents.
This computation, in the case of _Multibranch Pipeline_ projects, creates child items for each eligible branch within the child.
For _Organization Folders_, computation populates child items for repositories as individual _Multibranch Pipelines_.

Folder computation may happen automatically via webhook callbacks, as branches and repositories are created or removed.
Computation may also be triggered by the _Build Trigger_ defined in the configuration, which will automatically run a computation task after a period of inactivity (this defaults to run after one day).

[role="image-border"]
image:ch19/folder-computation-build-trigger-schedule.png[scaledwidth="75%"]

Information about the last execution of the folder computation is available in the *Folder Computation* section.

[role="image-border"]
image:ch19/folder-computation-main.png[scaledwidth="75%",width="75%"]

The log from the last attempt to compute the folder is available from this page.
If folder computation doesn't result in an expected set of repositories, the log may have useful information to diagnose the problem.

[role="image-border"]
image:ch19/folder-computation-log.png[scaledwidth="75%",width="75%"]


[id=pipeline-as-code-configuration]
=== Configuration

Both _Multibranch Pipeline_ projects and _Organization Folders_ have configuration options to allow precise selection of repositories.
These features also allow selection of two types of credentails to use when connecting to the remote systems:

* _scan_ credentials, which are used for accessing the GitHub or Bitbucket APIs
* _checkout_ credentials, which are used when the repository is cloned from the remote system; it may be useful to choose an SSH key or _"- anonymous -"_, which uses the default credentials configured for the OS user

[IMPORTANT]
If you are using a _GitHub Organization_, you should link:https://github.com/settings/tokens/new?scopes=repo,public_repo,admin:repo_hook,admin:org_hook&amp;description=Jenkins+Access[create a GitHub access token] to use to avoid storing your password in Jenkins and prevent any issues when using the GitHub API.
When using a GitHub access token, you must use standard _Username with password_ credentials, where the username is the same as your GitHub username and the password is your access token.

==== Multibranch Pipeline Projects

_Multibranch Pipeline_ projects are one of the fundamental enabling features for _Pipeline as Code_.
Changes to the build or deployment procedure can evolve with project requirements and the job always reflects the current state of the project.
It also allows you to configure different jobs for different branches of the same project, or to forgo a job if appropriate.
The `Jenkinsfile` in the root directory of a branch or pull request identifies a multibranch project.

[NOTE]
_Multibranch Pipeline_ projects expose the name of the branch being built with the `BRANCH_NAME` environment variable and provide a special `checkout scm`
Pipeline command, which is guaranteed to check out the specific commit that the Jenkinsfile originated.
If the Jenkinsfile needs to check out the repository for any reason, make sure to use `checkout scm`, as it also accounts for alternate origin repositories to handle things like pull requests.

To create a _Multibranch Pipeline_, go to: _New Item -> Multibranch Pipeline_.
Configure the SCM source as appropriate.
There are options for many different types of repositories and services including Git, Mercurial, Bitbucket, and GitHub.
If using GitHub, for example, click *Add source*, select GitHub and configure the appropriate owner, scan credentials, and repository.

Other options available to _Multibranch Pipeline_ projects are:

* *API endpoint* - an alternate API endpoint to use a self-hosted GitHub Enterprise
* *Checkout credentials* - alternate credentials to use when checking out the code (cloning)
* *Include branches* - a regular expression to specify branches to include
* *Exclude branches* - a regular expression to specify branches to exclude; note that this will take precedence over includes
* *Property strategy* - if necessary, define custom properties for each branch

After configuring these items and saving the configuration, Jenkins will automatically scan the repository and import appropriate branches.

==== Organization Folders

Organization Folders offer a convenient way to allow Jenkins to automatically manage which repositories are automatically included in Jenkins.
Particularly, if your organization utilizes _GitHub Organizations_ or _Bitbucket Teams_, any time a developer creates a new repository
with a `Jenkinsfile`, Jenkins will automatically detect it and create a _Multibranch Pipeline_ project for it.
This alleviates the need for administrators or developers to manually create projects for these new repositories.

To create an _Organization Folder_ in Jenkins, go to: *New Item -> GitHub Organization* or *New Item -> Bitbucket Team* and follow the configuration steps for each item,
making sure to specify appropriate _Scan Credentials_ and a specific *owner* for the GitHub Organization or Bitbucket Team name, respectively.

Other options available are:

* *Repository name pattern* - a regular expression to specify which repositories are *included*
* *API endpoint* - an alternate API endpoint to use a self-hosted GitHub Enterprise
* *Checkout credentials* - alternate credentials to use when checking out the code (cloning)

After configuring these items and saving the configuration, Jenkins will automatically scan the organization and import appropriate repositories and resulting branches.


==== Orphaned Item Strategy

Computed folders can remove items immediately or leave them based on a desired retention strategy.
By default, items will be removed as soon as the folder computation determines they are no longer present.
If your organization requires these items remain available for a longer period of time, simply configure the Orphaned Item Strategy appropriately.
It may be useful to keep items in order to examine build results of a branch after it's been removed, for example.

[role="image-border"]
image:ch19/orphaned-item-strategy.png[scaledwidth="75%"]

==== Icon and View Strategy

You may also configure an icon to use for the folder display.
For example, it might be useful to display an aggregate health of the child builds.
Alternately, you might reference the same icon you use in your GitHub organization account.

[role="image-border"]
image:ch19/folder-icon.png[scaledwidth="75%"]


[id=pipeline-as-code-example]
=== Example

To demonstrate using an Organization Folder to manage repositories, we'll use the fictitious organization: CloudBeers, Inc..

Go to *New Item*.
Enter 'cloudbeers' for the item name.
Select *GitHub Organization* and click *OK*.

[role="image-border"]
image:ch19/screenshot1.png[scaledwidth="75%"]

Optionally, enter a better descriptive name for the _Description_, such as 'CloudBeers GitHub'.
In the _Repository Sources_ section, complete the section for "GitHub Organization". 
Make sure the *owner* matches the GitHub Organization name exactly, in our case it must be: _cloudbeers_.
This defaults to the same value that was entered for the item name in the first step.
Next, select or add new "Scan credentials" - we'll enter our GitHub username and access token as the password.

[role="image-border"]
image:ch19/screenshot2.png[scaledwidth="75%"]

After saving, the "Folder Computation" will run to scan for eligible repositories, followed by multibranch builds.

[role="image-border"]
image:ch19/screenshot3.png[scaledwidth="75%"]

Refresh the page after the job runs to ensure the view of repositories has been updated.

[role="image-border"]
image:ch19/screenshot4.png[scaledwidth="75%"]

A this point, you're finished with basic project configuration and can now explore your imported repositories. 
You can also investigate the results of the jobs run as part of the initial _Folder Computation_.

[role="image-border"]
image:ch19/screenshot5.png[scaledwidth="75%"]

To utilize _Bitbucket Team_, follow the same set of steps, selecting *Bitbucket Team* instead of *GitHub Organization* as the new item type, and entering appropriate Bitbucket credentials.


[id=pipeline-as-code-additional-resources]
=== Additional Resources

* link:../cookbook/_continuous_delivery_with_jenkins_workflow.html[Continuous Delivery with Jenkins Pipeline]
* link:https://github.com/jenkinsci/workflow-plugin/blob/master/TUTORIAL.md#creating-multibranch-projects[Creating Multibranch Projects]
* link:https://dzone.com/refcardz/continuous-delivery-with-jenkins-workflow[Jenkins Pipeline DZone Refcard] - highlights ways to integrate your organization's tools as well as advanced topics such as Docker
* link:https://github.com/kohsuke/docker-jenkins-demo-app[Docker Jenkins sample app] - uses Docker containers to manage test and deployment environments  

